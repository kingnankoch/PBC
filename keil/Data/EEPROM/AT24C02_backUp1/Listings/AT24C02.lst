C51 COMPILER V9.54   AT24C02                                                               02/09/2022 00:15:09 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE AT24C02
OBJECT MODULE PLACED IN .\Objects\AT24C02.obj
COMPILER INVOKED BY: C:\Program Files\Keil_v5\C51\BIN\C51.EXE AT24C02.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRIN
                    -T(.\Listings\AT24C02.lst) TABS(2) OBJECT(.\Objects\AT24C02.obj)

line level    source

   1          /**
   2           * @file AT24C02.c
   3           * @author kingnan (github.com/kingnan-Guo/PBC)
   4           * @brief å¯ä»¥ç”µæ“¦é™¤çš„ å†…éƒ¨å‚¨å­˜å™¨ï¼Œ æ–­ç”µä¸æ¶ˆå¤±;ä½¿ç”¨ I2Cçš„æ–¹å¼è¿›è¡Œæ•°æ®å­˜å‚¨
   5           * @version 0.1
   6           * @date 2022-02-06
   7           * 
   8           * @copyright Copyright (c) 2022
   9           * 
  10           */
  11          
  12          #include"reg51.h"
  13          #include"intrins.h"
  14          #include "stdio.h"
  15          
  16          // ----- I2C çš„æ¥å£ ------
  17          sbit SDA = P3^0;
  18          sbit SCL = P3^1;
  19          
  20          //  ----- æŒ‰é’® ---
  21          sbit button1 = P1^0;
  22          
  23          
  24          
  25          // ---- æµ‹è¯•å†™å…¥çš„æ•°æ® --
  26          unsigned char testData[] = {5, 0xFF, 7, 8};
  27          unsigned char bufferData[];
  28          
  29          
  30          
  31          // --- star -- æ­¤å¤„å­¦ä¹ ä¸€ä¸‹ _at_0x55  çš„å†™æ³• ï¼›æš‚æ—¶ä¸æ¸…æ¥šå…·ä½“ä»£è¡¨çš„æ„æ€ ----
  32          
  33          
  34          
  35          // unsigned char mem[4] _at_0x55; //ä¹¦ä¸Šè¯´ : å‘é€ç¼“å†²åŒºçš„é¦–åœ°å€(æˆ‘çš„ç†è§£ä¸ºï¼Œå°†mem[4] çš
             -„å­˜å‚¨çš„åœ°å€æŒ‡é’ˆæŒ‡å‘ 0x55)
  36          
  37          // unsigned char men[4] = {0x41, 0x42, 0x43,0x44}; // å‘0x55çš„åœ°å€ å­˜å…¥ å››ä¸ªæ•°æ®ï¼ˆé—®é¢˜æ˜¯å¦‚æ
             -œå­˜ä¸ä¸‹æ€ä¹ˆåŠï¼Ÿï¼Ÿï¼Ÿï¼‰
  38          //  -----------  end --------
  39          
  40          
  41          
  42          
  43          // åˆå§‹åŒ– AT24C02 
  44          // void initAT24C02() {
  45          //     _nop_();
  46          // }
  47          
  48          
  49          
  50          // å»¶æ—¶å‡½æ•°
  51          void delay(num) {
  52   1          int i = 0;
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 00:15:09 PAGE 2   

  53   1          for (i = 0; i < num; i++)
  54   1          {
  55   2              _nop_(); // _nop_(); ä»£è¡¨è¿è¡Œä¸€ä¸ªæœºå™¨å‘¨æœŸ. å¦‚æœè¿™ä¸ªå•ç‰‡æœºçš„æ™¶æŒ¯æ˜¯12Mçš„ï¼Œé‚£
             -ä¹ˆè¿™è°ƒä»£ç ä¼šè¿è¡Œ1US
  56   2              // printf("%d",num);
  57   2          }
  58   1      }
  59          
  60          // 89C51 æ²¡æœ‰I2Cï¼Œ æ‰€ä»¥ä½¿ç”¨æ¨¡æ‹Ÿæ—¶åºæ“ä½œ I2C
  61          // SCL åœ¨é«˜ç”µå¹³è¿‡ç¨‹ä¸­ï¼Œ SDA æœ‰ä¸‹é™æ²¿ï¼Œè¿™æ—¶ å¼€å¯äº†I2C
  62          void I2C_star() {
  63   1          SDA = 1;
  64   1          SCL = 1;
  65   1          delay(5); // å»¶æ—¶5us, æ—¶é—´è¦å¤§äº 4.7usï¼Œ 
  66   1          SDA = 0; // å°†SDAå¤„äºä½ç”µå¹³ï¼Œå¼€å§‹ I2C
  67   1          delay(5); // æ—¶é—´è¦å¤§äºé¢ 4us
  68   1          SCL = 0;
  69   1      
  70   1      }
  71          
  72          // åœæ­¢
  73          void I2C_stop() {
  74   1          SCL = 1;
  75   1          SDA = 0;
  76   1          delay(5);
  77   1          SDA = 1; // å½“ SCL ä¸ºé«˜ç”µå¹³çš„æƒ…å†µä¸‹ï¼Œ SDAä¸ºé«˜ç”µå¹³ï¼›
  78   1          delay(5);
  79   1          SCL = 0;
  80   1      }
  81          
  82          // å‘é€åº”ç­”ä½ 
  83          void sendAck(void) {
  84   1          SDA = 0; // å½“SCLä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDAä¸º0ï¼Œæ‰€ä»¥åº”ç­”ä¸º 0
  85   1          SCL = 1;
  86   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
  87   1          SCL = 0;
  88   1          // delay(1);
  89   1          SDA = 1;
  90   1      }
  91          
  92          // void sendAck(bit ask) {
  93          //     SDA = ask; // å½“SCLä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDAä¸º0ï¼Œæ‰€ä»¥åº”ç­”ä¸º 0
  94          //     SCL = 1;
  95          //     delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
  96          //     SCL = 0;
  97          //     delay(5);
  98          //     
  99          // }
 100          
 101          // å‘é€éåº”ç­”ä½
 102          void unAsk() {
 103   1          SDA = 1; // å½“SCLä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDAä¸º1ï¼Œæ‰€ä»¥ éåº”ç­”ä¸º 1
 104   1          SCL = 1;
 105   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
 106   1          SCL = 0;
 107   1          SDA = 1;
 108   1      }
 109          
 110          
 111          // æ¥å—åº”ç­”ä¿¡å·
 112          bit recvAck() {
 113   1          unsigned char flat;
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 00:15:09 PAGE 3   

 114   1          SCL = 1;
 115   1          delay(5);
 116   1          //ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­” ï¼šå¦‚æœæœ‰åº”ç­” é‚£ä¹ˆ å™¨ä»¶ä¼šé€šè¿‡ SDA è¿™æ¡çº¿ä¼
             - å›æ•°æ®ï¼Œè¿™æ—¶å•ç‰‡æœºçš„SDAï¼š P1^0 ä¼šæœ‰ç”µå¹³çš„ å˜åŒ–
 117   1          flat = SDA; // å½“ SCLä¸º é«˜ç”µå¹³çš„æ—¶å€™ æ£€æµ‹ SDA çº¿ä¸Šçš„æ•°æ®
 118   1          SCL = 0; // æ•°æ®æ¥å—å®Œæˆåï¼Œ å°†æ—¶é’Ÿç”µå¹³æ‹‰ä½
 119   1          delay(5);
 120   1          return flat; // ä¸º 0 æ—¶ æ˜¯åº”ç­” ä¸º1 æ—¶ æ˜¯éåº”ç­”
 121   1      }
 122          
 123          
 124          
 125          
 126          // å•ç‰‡æœºå‘ å™¨ä»¶å‘é€ä¿¡å·
 127          void sendByte(unsigned char dat){
 128   1          unsigned char i;
 129   1          for (i = 0; i < 8; i++)
 130   1          {
 131   2              
 132   2              SDA = dat & 0x80;
 133   2              SCL = 1;
 134   2              delay(5);
 135   2              SCL = 0;
 136   2              dat <<= 1;
 137   2          }
 138   1          
 139   1      }
 140          
 141          bit readByte(){
 142   1          unsigned char i;
 143   1          unsigned char bufferData;
 144   1          for (i = 0; i < 8; i++)
 145   1          {
 146   2              SCL = 1;
 147   2              delay(5);
 148   2              bufferData |= SDA; // è‹¥SDA = 1ï¼Œ bufferData = 0000 0000 ï¼› bufferData |= SDA , bufferData = 00
             -00 0001 ; bufferData <<=1, bufferData = 0000 0010 ; 
 149   2              SCL = 0;
 150   2              delay(5);
 151   2              bufferData <<= 1;
 152   2          }
 153   1          return bufferData;
 154   1          
 155   1      }
 156          
 157          
 158          /**
 159           * @brief å†™æ“ä½œæ­¥éª¤
 160           * 1ã€å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 161           * 2ã€å™¨ä»¶å¯»å€æ“ä½œ 1010 A0 A1 A2 W/R  (å¯»å€å†™: 1010 0000)  
 162           * 3ã€ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”
 163           * 4ã€å•ç‰‡æœºå®Œæˆç‰‡å†…åœ°å€æ“ä½œ  (é¦–åœ°å€ï¼š 00H)
 164           * 5ã€å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 165           * 
 166           * å•ç‰‡æœºå‘é€æ•°æ®å­—èŠ‚
 167           * å™¨ä»¶äº§ç”Ÿåº”ç­”
 168           * å•ç‰‡æœºå‘å‡ºåœæ­¢ä¿¡å· P :  I2C_stop
 169           * 
 170           * 
 171           */
 172          
 173          // å•ç‰‡æœº å†™
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 00:15:09 PAGE 4   

 174          void AT24C02_write(){
 175   1          unsigned char i;
 176   1          bit flat;
 177   1          I2C_star(); //èµ·å§‹ä¿¡å·
 178   1          sendByte(0xa0);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 179   1          // sendByte(0xa2);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 180   1          flat = recvAck(); //åº”ç­”
 181   1          sendByte(0x30); // å‘é€å‚¨å­˜å•åœ°å€
 182   1          flat = recvAck(); //åº”ç­”
 183   1      
 184   1          // å¼€å§‹å†™å…¥æ•°æ®
 185   1          for (i = 0; i < 4; i++)
 186   1          {
 187   2              sendByte(testData[i]);
 188   2              flat = recvAck(); //åº”ç­”
 189   2              if(flat) break;
 190   2          }
 191   1          I2C_stop(); // åœæ­¢
 192   1      }
 193          
 194          
 195          
 196          
 197          
 198          
 199          /**
 200           * @brief å½“å‰åœ°å€è¯»æ“ä½œ
 201           * 1ã€å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 202           * 2ã€å™¨ä»¶å¯»å€è¯»æ“ä½œ 1010 A0 A1 A2 W/R  (å¯»å€è¯»: 1010 0001)  
 203           * 3ã€ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 204           * 4ã€å™¨ä»¶å‘é€æ•°æ®å­—èŠ‚
 205           * 5ã€å•ç‰‡æœºå›å¤å¤åº”ç­”
 206           * 6ã€å•ç‰‡æœºå‘å‡ºåœæ­¢ä¿¡å· P :   I2C_stop
 207           * 
 208           * @return int 
 209           */
 210          
 211          
 212          
 213          /**
 214           * @brief éšæœºè¯» : è¯»å¤šä¸ªå­—èŠ‚
 215           * å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 216           * å•ç‰‡æœºå®Œæˆ å™¨ä»¶å¯»å€å†™æ“ä½œ ï¼ˆä¼ªå†™ï¼‰
 217           * ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 218           * å•ç‰‡æœºå®Œæˆ æ•°æ®åœ°å€å†™æ“ä½œ ï¼ˆä¼ªå†™ï¼‰
 219           * ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 220           * 
 221           * å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 222           * å•ç‰‡æœºå®Œæˆ å™¨ä»¶å¯»å€ è¯»æ“ä½œ
 223           * ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 224           * 
 225           * å™¨ä»¶å‘é€æ•°æ®å­—èŠ‚
 226           * å•ç‰‡æœºäº§ç”Ÿåº”ç­”
 227           * 
 228           * å•ç‰‡æœºå‘å‡ºéåº”ç­”åŠåœæ­¢ä¿¡å· P :   I2C_stop
 229           * 
 230           * 
 231           * @return int 
 232           */
 233          
 234          
 235          
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 00:15:09 PAGE 5   

 236          // éšæœºè¯»
 237          void AT24C02_read() {
 238   1          unsigned char i,flat;
 239   1          I2C_star();
 240   1          sendByte(0xa0);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 241   1          flat = recvAck(); //åº”ç­”
 242   1          sendByte(0x00); // å‘é€å‚¨å­˜å•åœ°å€
 243   1          flat = recvAck(); //åº”ç­”
 244   1      
 245   1          I2C_star();
 246   1          sendByte(0xa1); // å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0001)
 247   1          for ( i = 0; i < 4; i++)
 248   1          {
 249   2              /* code */
 250   2              bufferData[i] = readByte();
 251   2              // men[i] = readByte();
 252   2              // if(i == 3){
 253   2              //     unAsk();
 254   2              // } else {
 255   2              //     recvAck();
 256   2              // }
 257   2              i == 3 ? unAsk() : recvAck();
 258   2          }
 259   1      
 260   1          I2C_stop();
 261   1      }
 262          
 263          
 264          
 265          
 266          
 267          int main()
 268          {
 269   1          // delay(5);
 270   1          // printf("hello word \r\n");
 271   1          AT24C02_write();
 272   1          // return 0;
 273   1      }
 274          
*** WARNING C290 IN LINE 273 OF AT24C02.c: missing return value


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    253    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
