C51 COMPILER V9.54   AT24C02                                                               02/09/2022 15:32:47 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE AT24C02
OBJECT MODULE PLACED IN .\Objects\AT24C02.obj
COMPILER INVOKED BY: C:\Program Files\Keil_v5\C51\BIN\C51.EXE AT24C02.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRIN
                    -T(.\Listings\AT24C02.lst) TABS(2) OBJECT(.\Objects\AT24C02.obj)

line level    source

   1          /**
   2           * @file AT24C02.c
   3           * @author kingnan (github.com/kingnan-Guo/PBC)
   4           * @brief å¯ä»¥ç”µæ“¦é™¤çš„ å†…éƒ¨å‚¨å­˜å™¨ï¼Œ æ–­ç”µä¸æ¶ˆå¤±;ä½¿ç”¨ I2Cçš„æ–¹å¼è¿›è¡Œæ•°æ®å­˜å‚¨
   5           * @version 0.1
   6           * @date 2022-02-06
   7           * 
   8           * @copyright Copyright (c) 2022
   9           * 
  10           */
  11          
  12          #include"reg51.h"
  13          #include"intrins.h"
  14          #include "stdio.h"
  15          
  16          #include <stdlib.h> //éšæœºæ•°
  17          
  18          // ----- I2C çš„æ¥å£ ------
  19          sbit SDA = P3^0;
  20          sbit SCL = P3^1;
  21          
  22          //  ----- æŒ‰é’® ---
  23          sbit button1 = P1^0;
  24          
  25          
  26          
  27          // ---- æµ‹è¯•å†™å…¥çš„æ•°æ® --
  28          unsigned char testData[] = {2, 4, 6, 8, 1, 0xFF, 3, 5};
  29          unsigned char bufferData[] = {1, 2, 3, 4};
  30          
  31          
  32          unsigned char testData1[] = {1, 2, 3, 30, 4, 0xFF, 6, 8};
  33          unsigned char testData2[] = {1, 8, 5, 4, 5, 1, 1, 7};
  34          
  35          
  36          
  37          
  38          // --- star -- æ­¤å¤„å­¦ä¹ ä¸€ä¸‹ _at_0x55  çš„å†™æ³• ï¼›æš‚æ—¶ä¸æ¸…æ¥šå…·ä½“ä»£è¡¨çš„æ„æ€ ----
  39          
  40          
  41          
  42          // unsigned char mem[4] _at_0x55; //ä¹¦ä¸Šè¯´ : å‘é€ç¼“å†²åŒºçš„é¦–åœ°å€(æˆ‘çš„ç†è§£ä¸ºï¼Œå°†mem[4] çš
             -„å­˜å‚¨çš„åœ°å€æŒ‡é’ˆæŒ‡å‘ 0x55)
  43          
  44          // unsigned char men[4] = {0x41, 0x42, 0x43,0x44}; // å‘0x55çš„åœ°å€ å­˜å…¥ å››ä¸ªæ•°æ®ï¼ˆé—®é¢˜æ˜¯å¦‚æ
             -œå­˜ä¸ä¸‹æ€ä¹ˆåŠï¼Ÿï¼Ÿï¼Ÿï¼‰
  45          //  -----------  end --------
  46          
  47          // ä½¿ç”¨æ•°å­—ç¯ å±•ç¤ºè¯»å–å‡ºçš„æ–‡å­—
  48          char segArr[] = {0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07, 0x7F, 0x6F};
  49          
  50          
  51          
  52          // åˆå§‹åŒ– AT24C02 
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 15:32:47 PAGE 2   

  53          // void initAT24C02() {
  54          //     _nop_();
  55          // }
  56          
  57          
  58          
  59          // å»¶æ—¶å‡½æ•°
  60          void delay(num) {
  61   1          int i = 0;
  62   1          for (i = 0; i < num; i++)
  63   1          {
  64   2              _nop_(); // _nop_(); ä»£è¡¨è¿è¡Œä¸€ä¸ªæœºå™¨å‘¨æœŸ. å¦‚æœè¿™ä¸ªå•ç‰‡æœºçš„æ™¶æŒ¯æ˜¯12Mçš„ï¼Œé‚£
             -ä¹ˆè¿™è°ƒä»£ç ä¼šè¿è¡Œ1US
  65   2              // printf("%d",num);
  66   2          }
  67   1      }
  68          
  69          // 89C51 æ²¡æœ‰I2Cï¼Œ æ‰€ä»¥ä½¿ç”¨æ¨¡æ‹Ÿæ—¶åºæ“ä½œ I2C
  70          // SCL åœ¨é«˜ç”µå¹³è¿‡ç¨‹ä¸­ï¼Œ SDA æœ‰ä¸‹é™æ²¿ï¼Œè¿™æ—¶ å¼€å¯äº†I2C
  71          void I2C_star() {
  72   1          SDA = 1;
  73   1          SCL = 1;
  74   1          delay(5); // å»¶æ—¶5us, æ—¶é—´è¦å¤§äº 4.7usï¼Œ 
  75   1          SDA = 0; // å°†SDAå¤„äºä½ç”µå¹³ï¼Œå¼€å§‹ I2C
  76   1          delay(5); // æ—¶é—´è¦å¤§äºé¢ 4us
  77   1          SCL = 0;
  78   1      
  79   1      }
  80          
  81          // åœæ­¢
  82          void I2C_stop() {
  83   1          SCL = 0;
  84   1          SDA = 0;
  85   1          delay(5);
  86   1          SCL = 1;
  87   1          delay(5);
  88   1          SDA = 1; // å½“ SCL ä¸ºé«˜ç”µå¹³çš„æƒ…å†µä¸‹ï¼Œ SDAä¸ºé«˜ç”µå¹³ï¼›
  89   1          delay(5);
  90   1          SDA = 0;
  91   1      }
  92          
  93          // å‘é€åº”ç­”ä½ 
  94          void sendAck(void) {
  95   1          SDA = 0; // å½“SCLä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDAä¸º0ï¼Œæ‰€ä»¥åº”ç­”ä¸º 0
  96   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
  97   1          SCL = 1;
  98   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
  99   1          SCL = 0;
 100   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
 101   1          // delay(1);
 102   1          SDA = 1;
 103   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
 104   1      }
 105          
 106          // void sendAck(bit ask) {
 107          //     SDA = ask; // å½“SCLä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDAä¸º0ï¼Œæ‰€ä»¥åº”ç­”ä¸º 0
 108          //     SCL = 1;
 109          //     delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
 110          //     SCL = 0;
 111          //     delay(5);
 112          //     
 113          // }
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 15:32:47 PAGE 3   

 114          
 115          // å‘é€éåº”ç­”ä½
 116          void unAsk() {
 117   1          SDA = 1; // å½“SCLä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDAä¸º1ï¼Œæ‰€ä»¥ éåº”ç­”ä¸º 1
 118   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
 119   1          SCL = 1;
 120   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
 121   1          SCL = 0;
 122   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
 123   1          SDA = 0;
 124   1      }
 125          
 126          
 127          // æ¥å—åº”ç­”ä¿¡å·
 128          bit recvAck() {
 129   1          bit flat;
 130   1          SCL = 1;
 131   1          delay(5);
 132   1          //ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­” ï¼šå¦‚æœæœ‰åº”ç­” é‚£ä¹ˆ å™¨ä»¶ä¼šé€šè¿‡ SDA è¿™æ¡çº¿ä¼
             - å›æ•°æ®ï¼Œè¿™æ—¶å•ç‰‡æœºçš„SDAï¼š P1^0 ä¼šæœ‰ç”µå¹³çš„ å˜åŒ–
 133   1          flat = SDA; // å½“ SCLä¸º é«˜ç”µå¹³çš„æ—¶å€™ æ£€æµ‹ SDA çº¿ä¸Šçš„æ•°æ®
 134   1          SCL = 0; // æ•°æ®æ¥å—å®Œæˆåï¼Œ å°†æ—¶é’Ÿç”µå¹³æ‹‰ä½
 135   1          delay(5);
 136   1          return(flat); // ä¸º 0 æ—¶ æ˜¯åº”ç­” ä¸º1 æ—¶ æ˜¯éåº”ç­”
 137   1      }
 138          
 139          
 140          
 141          
 142          // å•ç‰‡æœºå‘ å™¨ä»¶å‘é€ä¿¡å·
 143          void sendByte(unsigned char dat){
 144   1          unsigned char i;
 145   1          SCL = 0;
 146   1          for (i = 0; i < 8; i++)
 147   1          {
 148   2              
 149   2              SDA = dat & 0x80;
 150   2              SCL = 1;
 151   2              delay(5);
 152   2              SCL = 0;
 153   2              dat <<= 1;
 154   2          }
 155   1          
 156   1      }
 157          
 158          unsigned char readByte(){
 159   1          unsigned char i;
 160   1          unsigned char temp = 0x00;
 161   1          // SDA = 1;
 162   1          // delay(10);
 163   1          // unsigned char tempSDA[8] = {00000010};
 164   1          for (i = 0; i < 8; i++)
 165   1          {
 166   2              temp <<= 1;  
 167   2              SCL = 1;
 168   2              delay(5);
 169   2              temp |= SDA; // è‹¥SDA = 1ï¼Œ bufferData = 0000 0000 ï¼› bufferData |= SDA , bufferData = 0000 000
             -1 ; bufferData <<=1, bufferData = 0000 0010 ; 
 170   2              SCL = 0;
 171   2              delay(5);
 172   2              
 173   2          }
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 15:32:47 PAGE 4   

 174   1          return (temp);
 175   1      
 176   1      
 177   1      
 178   1          // unsigned char  i;
 179   1          // unsigned char  dat;
 180   1          // SCL=0;
 181   1          // delay(8);
 182   1          // SDA=1;
 183   1          // delay(8);
 184   1          // for(i=0;i<8;i++)
 185   1          // {
 186   1          //     SCL=1;
 187   1          //     delay(5);
 188   1          //     dat=dat<<1;
 189   1          //     if(SDA)
 190   1          //     {
 191   1          //         dat++;// 
 192   1          //     }
 193   1          //     SCL=0;
 194   1          //     delay(5);
 195   1          // }
 196   1          // return dat; 
 197   1      
 198   1          
 199   1      }
 200          
 201          
 202          /**
 203           * @brief å†™æ“ä½œæ­¥éª¤
 204           * 1ã€å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 205           * 2ã€å™¨ä»¶å¯»å€æ“ä½œ 1010 A0 A1 A2 W/R  (å¯»å€å†™: 1010 0000)  
 206           * 3ã€ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”
 207           * 4ã€å•ç‰‡æœºå®Œæˆç‰‡å†…åœ°å€æ“ä½œ  (é¦–åœ°å€ï¼š 00H)
 208           * 5ã€å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 209           * 
 210           * å•ç‰‡æœºå‘é€æ•°æ®å­—èŠ‚
 211           * å™¨ä»¶äº§ç”Ÿåº”ç­”
 212           * å•ç‰‡æœºå‘å‡ºåœæ­¢ä¿¡å· P :  I2C_stop
 213           * 
 214           * 
 215           */
 216          
 217          // å•ç‰‡æœº å†™
 218          void AT24C02_write(){
 219   1          unsigned char i;
 220   1          bit flat;
 221   1          I2C_star(); //èµ·å§‹ä¿¡å·
 222   1          // sendByte(0xa0);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 223   1          sendByte(0xa2);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 224   1          flat = recvAck(); //åº”ç­”
 225   1      
 226   1      
 227   1      
 228   1          if(!flat) {
 229   2              sendByte(0x30); // å‘é€å‚¨å­˜å•åœ°å€
 230   2              flat = recvAck(); //åº”ç­”
 231   2      
 232   2              if(!flat) {
 233   3      
 234   3                  // å¼€å§‹å†™å…¥æ•°æ®
 235   3                  for (i = 0; i < 8; i++)
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 15:32:47 PAGE 5   

 236   3                  {
 237   4                      sendByte(testData[i]);
 238   4                      flat = recvAck(); //åº”ç­”
 239   4                      if(flat) break;
 240   4                  }
 241   3      
 242   3      
 243   3              }
 244   2      
 245   2          }
 246   1      
 247   1          I2C_stop(); // åœæ­¢
 248   1      }
 249          
 250          
 251          
 252          // è‡ªå®šä¹‰å†™å…¥
 253          void AT24C02_write_addr(I2CAddr, addr){
 254   1          unsigned char i;
 255   1          bit flat;
 256   1          I2C_star(); //èµ·å§‹ä¿¡å·
 257   1          // sendByte(0xa0);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 258   1          sendByte(I2CAddr);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 259   1          flat = recvAck(); //åº”ç­”
 260   1      
 261   1          
 262   1      
 263   1          if(!flat) {
 264   2              sendByte(addr); // å‘é€å‚¨å­˜å•åœ°å€
 265   2              flat = recvAck(); //åº”ç­”
 266   2      
 267   2              if(!flat) {
 268   3      
 269   3                  // å¼€å§‹å†™å…¥æ•°æ®
 270   3                  for (i = 0; i < 8; i++)
 271   3                  {
 272   4                      int B = rand();
 273   4                      sendByte(B % 10);
 274   4                      flat = recvAck(); //åº”ç­”
 275   4                      if(flat) break;
 276   4                  }
 277   3      
 278   3      
 279   3              }
 280   2      
 281   2          }
 282   1      
 283   1          I2C_stop(); // åœæ­¢
 284   1      }
 285          
 286          
 287          
 288          
 289          
 290          
 291          
 292          /**
 293           * @brief å½“å‰åœ°å€è¯»æ“ä½œ
 294           * 1ã€å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 295           * 2ã€å™¨ä»¶å¯»å€è¯»æ“ä½œ 1010 A0 A1 A2 W/R  (å¯»å€è¯»: 1010 0001)  
 296           * 3ã€ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 297           * 4ã€å™¨ä»¶å‘é€æ•°æ®å­—èŠ‚
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 15:32:47 PAGE 6   

 298           * 5ã€å•ç‰‡æœºå›å¤å¤åº”ç­”
 299           * 6ã€å•ç‰‡æœºå‘å‡ºåœæ­¢ä¿¡å· P :   I2C_stop
 300           * 
 301           * @return int 
 302           */
 303          
 304          
 305          
 306          /**
 307           * @brief éšæœºè¯» : è¯»å¤šä¸ªå­—èŠ‚
 308           * å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 309           * å•ç‰‡æœºå®Œæˆ å™¨ä»¶å¯»å€å†™æ“ä½œ ï¼ˆä¼ªå†™ï¼‰
 310           * ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 311           * å•ç‰‡æœºå®Œæˆ æ•°æ®åœ°å€å†™æ“ä½œ ï¼ˆä¼ªå†™ï¼‰
 312           * ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 313           * 
 314           * å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 315           * å•ç‰‡æœºå®Œæˆ å™¨ä»¶å¯»å€ è¯»æ“ä½œ
 316           * ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 317           * 
 318           * å™¨ä»¶å‘é€æ•°æ®å­—èŠ‚
 319           * å•ç‰‡æœºäº§ç”Ÿåº”ç­”
 320           * 
 321           * å•ç‰‡æœºå‘å‡ºéåº”ç­”åŠåœæ­¢ä¿¡å· P :   I2C_stop
 322           * 
 323           * 
 324           * @return int 
 325           */
 326          
 327          
 328          
 329          void seg() {
 330   1          int i;
 331   1          for(i=0;i< 4; i++) {
 332   2              P2 = segArr[bufferData[i]];
 333   2              delay(10000);
 334   2          }
 335   1          // P2 = segArr[2];
 336   1      }
 337          
 338          // éšæœºè¯»
 339          void AT24C02_read() {
 340   1          unsigned char i;
 341   1          bit flat;
 342   1          I2C_star();
 343   1          sendByte(0xa0);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 344   1          flat = recvAck(); //åº”ç­”
 345   1          if(!flat) {
 346   2      
 347   2      
 348   2              I2C_star();
 349   2              sendByte(0xa0);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 350   2              flat = recvAck(); //åº”ç­”
 351   2              sendByte(0x00); // å‘é€å‚¨å­˜å•åœ°å€
 352   2              flat = recvAck(); //åº”ç­”
 353   2      
 354   2      
 355   2      
 356   2      
 357   2              I2C_star();
 358   2              sendByte(0xa1); // å‘é€è®¾å¤‡åœ°å€ + è¯»ä¿¡å· (1010 0001)
 359   2              flat = recvAck(); //åº”ç­” ****** ä¸ºä»€ä¹ˆä¸€ç›´æ²¡åŠæ³•è¯»å–åˆ°æ•°æ®ï¼Œå°±æ˜¯å› ä¸ºç¼ºå°‘ä¸€ä
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 15:32:47 PAGE 7   

             -¸ªåº”ç­”ä½
 360   2              for ( i = 0; i < 4; i++)
 361   2              {
 362   3                  /* code */
 363   3                  bufferData[i] = readByte(); //è¿™é‡Œæ— æ³•è¯»å–åˆ°æ•°æ®ä¸çŸ¥ä¸ºä½•,æ˜å¤©å‡†å¤‡è§£å†³ print
             -F åä¼šçŸ¥é“å…·ä½“ä¸ºä»€ä¹ˆæ— æ³•è¯»å–æ•°æ®
 364   3                  // bufferData[i] = i; 
 365   3                  // flat = recvAck(); //åº”ç­”
 366   3                  // men[i] = readByte();
 367   3                  
 368   3                  if(i == 3){
 369   4                      unAsk();
 370   4                  } else {
 371   4                      sendAck();
 372   4                  }
 373   3                  delay(4);
 374   3                  // i == 3 ? unAsk() : recvAck();
 375   3              }
 376   2      
 377   2      
 378   2      
 379   2      
 380   2          }
 381   1      
 382   1          I2C_stop();
 383   1        // bufferData[0] = 0;
 384   1          // bufferData[1] = 1;
 385   1          // bufferData[2] = 2;
 386   1          // bufferData[3] = 3;
 387   1      }
 388          
 389          
 390          
 391          
 392          
 393          int main()
 394          {
 395   1          // delay(5);
 396   1          // printf("hello word \r\n");
 397   1          // AT24C02_write();
 398   1          // delay(100);
 399   1      
 400   1          AT24C02_write_addr(0xa0, 0x50);
 401   1          delay(100);
 402   1          AT24C02_write_addr(0xa2, 0x80);
 403   1          delay(100);
 404   1          // AT24C02_read();
 405   1          // delay(100);
 406   1          // return 0;
 407   1      
 408   1          // while (1)
 409   1          // {
 410   1          //     /* code */
 411   1          //     seg();
 412   1          // }
 413   1          
 414   1      }
 415          
*** WARNING C290 IN LINE 414 OF AT24C02.c: missing return value


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 15:32:47 PAGE 8   

   CODE SIZE        =    450    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     38       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       4
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
