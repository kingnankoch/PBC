C51 COMPILER V9.54   AT24C02                                                               02/09/2022 01:20:05 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE AT24C02
OBJECT MODULE PLACED IN .\Objects\AT24C02.obj
COMPILER INVOKED BY: C:\Program Files\Keil_v5\C51\BIN\C51.EXE AT24C02.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRIN
                    -T(.\Listings\AT24C02.lst) TABS(2) OBJECT(.\Objects\AT24C02.obj)

line level    source

   1          /**
   2           * @file AT24C02.c
   3           * @author kingnan (github.com/kingnan-Guo/PBC)
   4           * @brief å¯ä»¥ç”µæ“¦é™¤çš„ å†…éƒ¨å‚¨å­˜å™¨ï¼Œ æ–­ç”µä¸æ¶ˆå¤±;ä½¿ç”¨ I2Cçš„æ–¹å¼è¿›è¡Œæ•°æ®å­˜å‚¨
   5           * @version 0.1
   6           * @date 2022-02-06
   7           * 
   8           * @copyright Copyright (c) 2022
   9           * 
  10           */
  11          
  12          #include"reg51.h"
  13          #include"intrins.h"
  14          #include "stdio.h"
  15          
  16          // ----- I2C çš„æ¥å£ ------
  17          sbit SDA = P3^0;
  18          sbit SCL = P3^1;
  19          
  20          //  ----- æŒ‰é’® ---
  21          sbit button1 = P1^0;
  22          
  23          
  24          
  25          // ---- æµ‹è¯•å†™å…¥çš„æ•°æ® --
  26          unsigned char testData[] = {2, 3, 7, 8};
  27          unsigned char bufferData[] = {1, 2, 3, 4};
  28          
  29          
  30          
  31          // --- star -- æ­¤å¤„å­¦ä¹ ä¸€ä¸‹ _at_0x55  çš„å†™æ³• ï¼›æš‚æ—¶ä¸æ¸…æ¥šå…·ä½“ä»£è¡¨çš„æ„æ€ ----
  32          
  33          
  34          
  35          // unsigned char mem[4] _at_0x55; //ä¹¦ä¸Šè¯´ : å‘é€ç¼“å†²åŒºçš„é¦–åœ°å€(æˆ‘çš„ç†è§£ä¸ºï¼Œå°†mem[4] çš
             -„å­˜å‚¨çš„åœ°å€æŒ‡é’ˆæŒ‡å‘ 0x55)
  36          
  37          // unsigned char men[4] = {0x41, 0x42, 0x43,0x44}; // å‘0x55çš„åœ°å€ å­˜å…¥ å››ä¸ªæ•°æ®ï¼ˆé—®é¢˜æ˜¯å¦‚æ
             -œå­˜ä¸ä¸‹æ€ä¹ˆåŠï¼Ÿï¼Ÿï¼Ÿï¼‰
  38          //  -----------  end --------
  39          
  40          // ä½¿ç”¨æ•°å­—ç¯ å±•ç¤ºè¯»å–å‡ºçš„æ–‡å­—
  41          char segArr[] = {0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07, 0x7F, 0x6F};
  42          
  43          
  44          
  45          // åˆå§‹åŒ– AT24C02 
  46          // void initAT24C02() {
  47          //     _nop_();
  48          // }
  49          
  50          
  51          
  52          // å»¶æ—¶å‡½æ•°
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 01:20:05 PAGE 2   

  53          void delay(num) {
  54   1          int i = 0;
  55   1          for (i = 0; i < num; i++)
  56   1          {
  57   2              _nop_(); // _nop_(); ä»£è¡¨è¿è¡Œä¸€ä¸ªæœºå™¨å‘¨æœŸ. å¦‚æœè¿™ä¸ªå•ç‰‡æœºçš„æ™¶æŒ¯æ˜¯12Mçš„ï¼Œé‚£
             -ä¹ˆè¿™è°ƒä»£ç ä¼šè¿è¡Œ1US
  58   2              // printf("%d",num);
  59   2          }
  60   1      }
  61          
  62          // 89C51 æ²¡æœ‰I2Cï¼Œ æ‰€ä»¥ä½¿ç”¨æ¨¡æ‹Ÿæ—¶åºæ“ä½œ I2C
  63          // SCL åœ¨é«˜ç”µå¹³è¿‡ç¨‹ä¸­ï¼Œ SDA æœ‰ä¸‹é™æ²¿ï¼Œè¿™æ—¶ å¼€å¯äº†I2C
  64          void I2C_star() {
  65   1          SDA = 1;
  66   1          SCL = 1;
  67   1          delay(5); // å»¶æ—¶5us, æ—¶é—´è¦å¤§äº 4.7usï¼Œ 
  68   1          SDA = 0; // å°†SDAå¤„äºä½ç”µå¹³ï¼Œå¼€å§‹ I2C
  69   1          delay(5); // æ—¶é—´è¦å¤§äºé¢ 4us
  70   1          SCL = 0;
  71   1      
  72   1      }
  73          
  74          // åœæ­¢
  75          void I2C_stop() {
  76   1          SCL = 1;
  77   1          SDA = 0;
  78   1          delay(5);
  79   1          SDA = 1; // å½“ SCL ä¸ºé«˜ç”µå¹³çš„æƒ…å†µä¸‹ï¼Œ SDAä¸ºé«˜ç”µå¹³ï¼›
  80   1          delay(5);
  81   1          SCL = 0;
  82   1      }
  83          
  84          // å‘é€åº”ç­”ä½ 
  85          void sendAck(void) {
  86   1          SDA = 0; // å½“SCLä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDAä¸º0ï¼Œæ‰€ä»¥åº”ç­”ä¸º 0
  87   1          SCL = 1;
  88   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
  89   1          SCL = 0;
  90   1          // delay(1);
  91   1          SDA = 1;
  92   1      }
  93          
  94          // void sendAck(bit ask) {
  95          //     SDA = ask; // å½“SCLä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDAä¸º0ï¼Œæ‰€ä»¥åº”ç­”ä¸º 0
  96          //     SCL = 1;
  97          //     delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
  98          //     SCL = 0;
  99          //     delay(5);
 100          //     
 101          // }
 102          
 103          // å‘é€éåº”ç­”ä½
 104          void unAsk() {
 105   1          SDA = 1; // å½“SCLä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDAä¸º1ï¼Œæ‰€ä»¥ éåº”ç­”ä¸º 1
 106   1          SCL = 1;
 107   1          delay(5); // æŒç»­æ—¶é—´ å¤§äº 4us
 108   1          SCL = 0;
 109   1          SDA = 1;
 110   1      }
 111          
 112          
 113          // æ¥å—åº”ç­”ä¿¡å·
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 01:20:05 PAGE 3   

 114          bit recvAck() {
 115   1          unsigned char flat;
 116   1          SCL = 1;
 117   1          delay(5);
 118   1          //ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­” ï¼šå¦‚æœæœ‰åº”ç­” é‚£ä¹ˆ å™¨ä»¶ä¼šé€šè¿‡ SDA è¿™æ¡çº¿ä¼
             - å›æ•°æ®ï¼Œè¿™æ—¶å•ç‰‡æœºçš„SDAï¼š P1^0 ä¼šæœ‰ç”µå¹³çš„ å˜åŒ–
 119   1          flat = SDA; // å½“ SCLä¸º é«˜ç”µå¹³çš„æ—¶å€™ æ£€æµ‹ SDA çº¿ä¸Šçš„æ•°æ®
 120   1          SCL = 0; // æ•°æ®æ¥å—å®Œæˆåï¼Œ å°†æ—¶é’Ÿç”µå¹³æ‹‰ä½
 121   1          delay(5);
 122   1          return flat; // ä¸º 0 æ—¶ æ˜¯åº”ç­” ä¸º1 æ—¶ æ˜¯éåº”ç­”
 123   1      }
 124          
 125          
 126          
 127          
 128          // å•ç‰‡æœºå‘ å™¨ä»¶å‘é€ä¿¡å·
 129          void sendByte(unsigned char dat){
 130   1          unsigned char i;
 131   1          for (i = 0; i < 8; i++)
 132   1          {
 133   2              
 134   2              SDA = dat & 0x80;
 135   2              SCL = 1;
 136   2              delay(5);
 137   2              SCL = 0;
 138   2              dat <<= 1;
 139   2          }
 140   1          
 141   1      }
 142          
 143          bit readByte(){
 144   1          unsigned char i;
 145   1          unsigned char bufferData;
 146   1          for (i = 0; i < 8; i++)
 147   1          {
 148   2              SCL = 1;
 149   2              delay(5);
 150   2              bufferData |= SDA; // è‹¥SDA = 1ï¼Œ bufferData = 0000 0000 ï¼› bufferData |= SDA , bufferData = 00
             -00 0001 ; bufferData <<=1, bufferData = 0000 0010 ; 
 151   2              SCL = 0;
 152   2              delay(5);
 153   2              bufferData <<= 1;
 154   2          }
 155   1          return bufferData;
 156   1          
 157   1      }
 158          
 159          
 160          /**
 161           * @brief å†™æ“ä½œæ­¥éª¤
 162           * 1ã€å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 163           * 2ã€å™¨ä»¶å¯»å€æ“ä½œ 1010 A0 A1 A2 W/R  (å¯»å€å†™: 1010 0000)  
 164           * 3ã€ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”
 165           * 4ã€å•ç‰‡æœºå®Œæˆç‰‡å†…åœ°å€æ“ä½œ  (é¦–åœ°å€ï¼š 00H)
 166           * 5ã€å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 167           * 
 168           * å•ç‰‡æœºå‘é€æ•°æ®å­—èŠ‚
 169           * å™¨ä»¶äº§ç”Ÿåº”ç­”
 170           * å•ç‰‡æœºå‘å‡ºåœæ­¢ä¿¡å· P :  I2C_stop
 171           * 
 172           * 
 173           */
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 01:20:05 PAGE 4   

 174          
 175          // å•ç‰‡æœº å†™
 176          void AT24C02_write(){
 177   1          unsigned char i;
 178   1          bit flat;
 179   1          I2C_star(); //èµ·å§‹ä¿¡å·
 180   1          sendByte(0xa0);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 181   1          // sendByte(0xa2);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 182   1          flat = recvAck(); //åº”ç­”
 183   1          sendByte(0x30); // å‘é€å‚¨å­˜å•åœ°å€
 184   1          flat = recvAck(); //åº”ç­”
 185   1      
 186   1          // å¼€å§‹å†™å…¥æ•°æ®
 187   1          for (i = 0; i < 4; i++)
 188   1          {
 189   2              sendByte(testData[i]);
 190   2              flat = recvAck(); //åº”ç­”
 191   2              if(flat) break;
 192   2          }
 193   1          I2C_stop(); // åœæ­¢
 194   1      }
 195          
 196          
 197          
 198          
 199          
 200          
 201          /**
 202           * @brief å½“å‰åœ°å€è¯»æ“ä½œ
 203           * 1ã€å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 204           * 2ã€å™¨ä»¶å¯»å€è¯»æ“ä½œ 1010 A0 A1 A2 W/R  (å¯»å€è¯»: 1010 0001)  
 205           * 3ã€ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 206           * 4ã€å™¨ä»¶å‘é€æ•°æ®å­—èŠ‚
 207           * 5ã€å•ç‰‡æœºå›å¤å¤åº”ç­”
 208           * 6ã€å•ç‰‡æœºå‘å‡ºåœæ­¢ä¿¡å· P :   I2C_stop
 209           * 
 210           * @return int 
 211           */
 212          
 213          
 214          
 215          /**
 216           * @brief éšæœºè¯» : è¯»å¤šä¸ªå­—èŠ‚
 217           * å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 218           * å•ç‰‡æœºå®Œæˆ å™¨ä»¶å¯»å€å†™æ“ä½œ ï¼ˆä¼ªå†™ï¼‰
 219           * ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 220           * å•ç‰‡æœºå®Œæˆ æ•°æ®åœ°å€å†™æ“ä½œ ï¼ˆä¼ªå†™ï¼‰
 221           * ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 222           * 
 223           * å•ç‰‡æœºå‘å‡ºèµ·å§‹ä¿¡å· :  I2C_star
 224           * å•ç‰‡æœºå®Œæˆ å™¨ä»¶å¯»å€ è¯»æ“ä½œ
 225           * ç­‰å¾…è¢«é€‰ä¸­çš„å™¨ä»¶è¿”å›ç¡®è®¤åº”ç­”ï¼ˆæˆ–éåº”ç­”ï¼‰
 226           * 
 227           * å™¨ä»¶å‘é€æ•°æ®å­—èŠ‚
 228           * å•ç‰‡æœºäº§ç”Ÿåº”ç­”
 229           * 
 230           * å•ç‰‡æœºå‘å‡ºéåº”ç­”åŠåœæ­¢ä¿¡å· P :   I2C_stop
 231           * 
 232           * 
 233           * @return int 
 234           */
 235          
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 01:20:05 PAGE 5   

 236          
 237          
 238          // éšæœºè¯»
 239          void AT24C02_read() {
 240   1          unsigned char i,flat;
 241   1          I2C_star();
 242   1          sendByte(0xa0);// å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0000)
 243   1          flat = recvAck(); //åº”ç­”
 244   1          sendByte(0x00); // å‘é€å‚¨å­˜å•åœ°å€
 245   1          flat = recvAck(); //åº”ç­”
 246   1      
 247   1          I2C_star();
 248   1          sendByte(0xa1); // å‘é€è®¾å¤‡åœ°å€ + å†™ä¿¡å· (1010 0001)
 249   1          for ( i = 0; i < 4; i++)
 250   1          {
 251   2              /* code */
 252   2              bufferData[i] = readByte();
 253   2              // men[i] = readByte();
 254   2              // if(i == 3){
 255   2              //     unAsk();
 256   2              // } else {
 257   2              //     recvAck();
 258   2              // }
 259   2              i == 3 ? unAsk() : recvAck();
 260   2          }
 261   1      
 262   1          I2C_stop();
 263   1      }
 264          
 265          
 266          void seg() {
 267   1          int i;
 268   1          for(i=0;i< 4; i++) {
 269   2              P2 = segArr[bufferData[i]];
 270   2              delay(10000);
 271   2          }
 272   1          // P2 = segArr[2];
 273   1      }
 274          
 275          
 276          int main()
 277          {
 278   1          // delay(5);
 279   1          // printf("hello word \r\n");
 280   1          AT24C02_write();
 281   1          // delay(10);
 282   1          // return 0;
 283   1          while (1)
 284   1          {
 285   2              /* code */
 286   2              seg();
 287   2          }
 288   1          
 289   1      }
 290          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    291    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.54   AT24C02                                                               02/09/2022 01:20:05 PAGE 6   

   DATA SIZE        =     18    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
